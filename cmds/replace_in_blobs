#!/usr/bin/env bash

set -Eeuo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "$0")" && pwd)"
ROOT_DIR="$(cd -- "${SCRIPT_DIR}/.." && pwd)"
. "${ROOT_DIR}/lib/common"

REPO_DIR="${REPO_DIR:?REPO_DIR is not set}"

print_help() {
  local cmd="${CMD:-}"
  [[ -z "${cmd}" ]] && cmd="$0"

  cat <<EOF
Usage:
  ${cmd} <search> <replacement> [-i] [-w] [-p=<pathspec>...]

Description:
  Perform a search-and-replace over blob contents across the full history.

Arguments:
  <search>          Regexp pattern to replace in blobs.
  <replacement>     Replacement text.

Options:
  -i                Ignore case.
  -w                Match the search term as a whole word (word-regex).
  -p=<pathspec>     Restrict changes to paths matching <pathspec>. May be repeated.
  --help            Show this help message and exit.

Environment:
  REPO_DIR          (required) Path to the target repository.

Examples:
  REPO_DIR="\$(pwd)" ${cmd} 'SECRET_TOKEN' 'REDACTED_TOKEN'
  REPO_DIR="\$(pwd)" ${cmd} 'secret_token' 'REDACTED_TOKEN' -i -w
  REPO_DIR="\$(pwd)" ${cmd} 'TODO ' 'TODO: ' -p='*.go' -p='docs/**'
  REPO_DIR="\$(pwd)" ${cmd} '(.+)Name' 'Name\\\\1'
EOF
}

# Produces in format commit:filepath:count (sorted by commit, filepath)
grep_commits() {
  local search="$1"
  local pathspec="$2"
  shift 2
  local grep_flags="$@"

  # --perl-regexp must not be used, but for some reason --extended-regexp doesn't work properly
  # Use --extended-regexp features and DO NOT use --perl-regexp features
  GIT --no-pager grep --no-color -I --name-only --perl-regexp ${grep_flags} -- "${search}" $(GIT rev-list --all) -- ${pathspec} || true
}

# Produces in format blob_sha
file_blobs() {
  sed -E 's/^([^:]+):(.+)$/\1:\2/' \
  | GIT cat-file --batch-check=$'%(objectname)' \
  | sort \
  | uniq
}

main() {
  has_flag "--help" "$@" && print_help && exit 0

  local search="$1"
  local replace="$2"
  local ignore_case=
  local word_regexp=
  local pathspec=

  shift 2
  has_flag "-i" "$@" && ignore_case="--ignore-case"
  has_flag "-w" "$@" && word_regexp="--word-regexp"
  has_flag "-p" "$@" && pathspec="$(flag_value "-p" "$@" | paste -sd' ' -)"

  local python_flags=
  local python_search="${search}"
  [[ -n "${ignore_case}" ]] && python_flags="flags=re.IGNORECASE"
  [[ -n "${word_regexp}" ]] && python_search="\\b${python_search}\\b"

  local python_blobs
  python_blobs="$(grep_commits "${search}" "${pathspec}" "${ignore_case}" "${word_regexp}" \
    | file_blobs \
    | sed -E 's/^(.+)$/b"\1",/' \
    | paste -sd' ' -
  )"

  [[ -z "${python_blobs}" ]] && die "Nothing to rewrite."

  local python_code
  python_code="$(cat <<EOF
import re, sys
blobs = { ${python_blobs} }
${if:-if} blob.original_id not in blobs:
    return

decoded = blob.data.decode('utf-8', 'surrogateescape')
blob.data = re.sub(r"${python_search}", "${replace}", decoded, ${python_flags}).encode('utf-8', 'surrogateescape')
EOF
)"

  GIT filter-repo --force --blob-callback "${python_code}"
}

main "$@"
