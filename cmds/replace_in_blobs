#!/usr/bin/env bash

set -Eeuo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "$0")" && pwd)"
ROOT_DIR="$(cd -- "${SCRIPT_DIR}/.." && pwd)"
. "${ROOT_DIR}/lib/common"

REPO_DIR="${REPO_DIR:?REPO_DIR is not set}"

print_help() {
  local cmd="${CMD:-}"
  [[ -z "${cmd}" ]] && cmd="$0"

  cat <<EOF
Usage:
  ${cmd} <search> <replacement> [-i] [-w] [-p=<pathspec>...]

Description:
  Perform a search-and-replace over blob contents across the full history.

Arguments:
  <search>          Pattern to replace.
  <replacement>     Replacement text.

Options:
  -i                Ignore case.
  -w                Match the search term as a whole word (word-regex).
  -p=<pathspec>     Restrict changes to paths matching <pathspec>. May be repeated.
  --help            Show this help message and exit.

Environment:
  REPO_DIR          (required) Path to the target repository.

Examples:
  REPO_DIR="\$(pwd)" ${cmd} 'SECRET_TOKEN' 'REDACTED_TOKEN'
  REPO_DIR="\$(pwd)" ${cmd} 'secret_token' 'REDACTED_TOKEN' -i -w
  REPO_DIR="\$(pwd)" ${cmd} 'TODO ' 'TODO: ' -p='*.go' -p='docs/**'
EOF
}

# Produces in format commit:filepath:count (sorted by commit, filepath)
grep_commits() {
  local search="$1"
  local pathspec="$2"
  shift 2
  local grep_flags="$@"

  GIT --no-pager grep --no-color -I -l ${grep_flags} -- "${search}" $(GIT rev-list --all) -- ${pathspec} || true
}

# Produces in format blob_sha
file_blobs() {
  sed -E 's/^([^:]+):(.+)$/\1:\2/' \
  | GIT cat-file --batch-check=$'%(objectname)' \
  | sort \
  | uniq
}

main() {
  has_flag "--help" "$@" && print_help && exit 0

  local search="$1"
  local replace="$2"
  local ignore_case=
  local word_regexp=
  local pathspec=

  shift 2
  has_flag "-i" "$@" && ignore_case="--ignore-case"
  has_flag "-w" "$@" && word_regexp="--word-regexp"
  has_flag "-p" "$@" && pathspec="$(flag_value "-p" "$@" | paste -sd' ' -)"

  local python_flags=
  local python_search="${search}"
  local python_regex=
  [[ -n "${ignore_case}" ]] && python_flags="flags=re.IGNORECASE" && python_regex='1'
  [[ -n "${word_regexp}" ]] && python_search="\\b${python_search}\\b" && python_regex='1'

  local python_re_sub="re.sub(br'${python_search}', b'${replace}', blob.data, ${python_flags})"
  local python_replace="blob.data.replace(b'${search}', b'${replace}')"
  local python_final_line=
  [[ -n "${python_regex}" ]] && python_final_line="${python_re_sub}" || python_final_line="${python_replace}"

  local python_blobs
  python_blobs="$(grep_commits "${search}" "${pathspec}" "${ignore_case}" "${word_regexp}" \
    | file_blobs \
    | sed -E 's/^(.+)$/b"\1",/' \
    | paste -sd' ' -
  )"

  [[ -z "${python_blobs}" ]] && die "Nothing to rewrite."

  local python_code
  python_code="$(cat <<EOF
import re, sys
blobs = { ${python_blobs} }
${if:-if} blob.original_id not in blobs:
    return

blob.data = ${python_final_line}
EOF
)"

  GIT filter-repo --force --blob-callback "${python_code}"
}

main "$@"
