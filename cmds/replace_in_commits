#!/usr/bin/env bash

set -Eeuo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "$0")" && pwd)"
ROOT_DIR="$(cd -- "${SCRIPT_DIR}/.." && pwd)"
. "${ROOT_DIR}/lib/common"

REPO_DIR="${REPO_DIR:?REPO_DIR is not set}"

print_help() {
  local cmd="${CMD:-}"
  [[ -z "${cmd}" ]] && cmd="$0"

  cat <<EOF
Usage:
  ${cmd} <search> <replacement> [-i] [-w]

Description:
  Perform a search-and-replace in commit messages across the full history.

Arguments:
  <search>          Pattern to replace in commit messages.
  <replacement>     Replacement text.

Options:
  -i                Ignore case.
  -w                Match the search term as a whole word (word-regex).
  --help            Show this help message and exit.

Environment:
  REPO_DIR          (required) Path to the target repository.

Examples:
  REPO_DIR="\$(pwd)" ${cmd} 'JIRA-' 'TASK-'
  REPO_DIR="\$(pwd)" ${cmd} 'wip' 'WIP' -i -w
EOF
}

main() {
  has_flag "--help" "$@" && print_help && exit 0

  local search="$1"
  local replace="$2"
  local ignore_case=
  local word_regexp=
  local perl_regexp=
  local grep="${search}"

  shift 2
  has_flag "-i" "$@" && ignore_case="-i"
  has_flag "-w" "$@" && word_regexp="--word-regexp" && perl_regexp="--perl-regexp"

  [[ -n "${word_regexp}" ]] && grep="$(printf '\\b\\Q%s\\E\\b' "${search}")"

  local python_flags=
  local python_search="${search}"
  [[ -n "${ignore_case}" ]] && python_flags="flags=re.IGNORECASE"
  [[ -n "${word_regexp}" ]] && python_search="\\b${python_search}\\b"

  local python_commits
  python_commits="$(GIT --no-pager log --pretty=format:%H --color=always --all --grep="${grep}" ${ignore_case} ${perl_regexp} \
    | sed -E 's/^(.+)$/b"\1",/' \
    | paste -sd' ' -
  )"

  [[ -z "${python_commits}" ]] && die "Nothing to rewrite."

  local python_code
  python_code="$(cat <<EOF
import re, sys
commits = { ${python_commits} }
${if:-if} commit.original_id not in commits:
    return

commit.message = re.sub(br"${python_search}", b"${replace}", commit.message, ${python_flags})
EOF
)"

  GIT filter-repo --force --commit-callback "${python_code}"
}

main "$@"
