#!/usr/bin/env bash

set -Eeuo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "$0")" && pwd)"
ROOT_DIR="$(cd -- "${SCRIPT_DIR}/.." && pwd)"
. "${ROOT_DIR}/lib/common"

REPO_DIR="${REPO_DIR:?REPO_DIR is not set}"

print_help() {
  local cmd="${CMD:-}"
  [[ -z "${cmd}" ]] && cmd="$0"

  cat <<EOF
Usage:
  ${cmd} <search> [-i] [-w]

Description:
  Search commit subjects and bodies across the full history.

  At the end, prints statistics: total commits scanned and total matches found.

Arguments:
  <search>          Regexp pattern to find.

Options:
  -i                Ignore case.
  -w                Match the search term as a whole word (word-regex).
  --help            Show this help message and exit.

Environment:
  REPO_DIR          (required) Path to the target repository.

Examples:
  REPO_DIR="\$(pwd)" ${cmd} 'fixup!'
  REPO_DIR="\$(pwd)" ${cmd} 'BREAKING' -i -w
  REPO_DIR="\$(pwd)" ${cmd} '^[a-z]+\$'
EOF
}

grep_commits() {
  local search="$1"; shift
  local grep_flags="$@"

  GIT --no-pager log --all --grep="${search}" ${grep_flags}
}

main() {
  has_flag "--help" "$@" && print_help && exit 0

  local search="$1"
  local ignore_case=
  local word_regexp=
  # --perl-regexp must not be used, but for some reason --extended-regexp doesn't work properly
  # Use --extended-regexp features and DO NOT use --perl-regexp features
  local perl_regexp="--perl-regexp"

  shift 1
  has_flag "-i" "$@" && ignore_case="-i"
  has_flag "-w" "$@" && word_regexp="--word-regexp"

  # git log doesn't support --word-regexp flag, so we do it ourselves
  [[ -n "${word_regexp}" ]] && search="$(printf '\\b%s\\b' "${search}")"

  grep_commits "${search}" ${ignore_case} ${perl_regexp} --color=always

  # Calculate stats
  local total_commits= total_found=
  total_commits="$(grep_commits "${search}" --pretty=format:%H ${ignore_case} ${perl_regexp} | grep -c '' || true)"
  total_found="$(grep_commits "${search}" --pretty=format:%B ${ignore_case} ${perl_regexp} \
    | grep -E -o "${search}" ${ignore_case} ${word_regexp} \
    | wc -l | awk '{print $1}' || true
  )"

  echo "Total commits: ${total_commits}"
  echo "Total found: ${total_found}"
}

main "$@"
